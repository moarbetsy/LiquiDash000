rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only access their own data
    match /users/{userId} {
      // Only authenticated users can access user data
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Subcollections under users
      match /{collectionName}/{documentId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Logs collection - users can only access their own logs
      match /logs/{logId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Global logs collection (if needed for admin purposes)
    match /logs/{logId} {
      // Only allow read for authenticated users, write only for specific admin users
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                   request.auth.token.email in ['admin@liquidash.com', 'support@liquidash.com'];
    }

    // Rate limiting to prevent abuse
    match /{document=**} {
      // Limit write operations per user per minute
      allow write: if request.auth != null &&
                   request.auth.token.firebase.sign_in_provider != 'anonymous' &&
                   // Add rate limiting logic here if needed
                   true;
    }
  }
}
